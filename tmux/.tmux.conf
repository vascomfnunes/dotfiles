# Enable true color
set-option default-terminal "xterm-kitty"
set-option -a terminal-overrides ",xterm-kitty:RGB"

# Define new prefix
set -g prefix2 C-a

gruvbox_material_black="#665c54"
gruvbox_material_blue="#7faea3"
gruvbox_material_yellow="#e78a4e"
gruvbox_material_red="#ea6962"
gruvbox_material_white="#d4be98"
gruvbox_material_green="#a9b665"
gruvbox_material_visual_grey="#3e4452"
gruvbox_material_comment_grey="#5c6370"

setw -q -g utf8 on

# Boost history
set -g history-limit 5000

# Enable mouse mode
set -g mouse on

# Don't rename windows automatically
set -wg automatic-rename on

# Faster command sequences
set -sg escape-time 0

# Increase repeat timeout
set -sg repeat-time 600

# Start windows/panes index at 1 and not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows
set -g renumber-windows on

# Set window titles automatically
set -g set-titles on

# Slightly longer pane indicators display time
set -g display-panes-time 800

# Slightly longer status messages display time
set -g display-time 1000

# Redraw the status line periodically
set -g status-interval 10

# By default, all windows in a session are constrained to the size of the smallest client connected to that session
setw -g aggressive-resize on

# Activity settings
set -g bell-action      any       # any: bells in any connected session alert in current window
set -g visual-bell      on        # visual bell, not audible
set -g visual-activity  on        # any attached window
set -g display-time     4000      # show messages for 4 seconds

# Set vi mode keys
setw -g mode-keys vi

# Default status area width
set -g status-left-length 100
set -g status-right-length 200

# Copy to Mac OSX clipboard on macOS
if-shell "uname | grep -q Darwin" "set-option -g default-command 'reattach-to-user-namespace -l zsh'"

if -b 'command -v reattach-to-user-namespace > /dev/null 2>&1' 'bind y run -b "tmux save-buffer - | reattach-to-user-namespace pbcopy"'

# ================ KEYBINDINGS ==================

# Reload configuration
bind r source-file ~/.tmux.conf \; display '~/.tmux.conf sourced'

# Edit configuration
bind e new-window -n '~/.tmux.conf' "sh -c '\${EDITOR:-vim} ~/.tmux.conf && tmux source ~/.tmux.conf && tmux display \"~/.tmux.conf sourced\"'"

# Faster window rename
bind , command-prompt -p "(rename-window '#W')" "rename-window '%%'"

# faster session rename
bind '$' command-prompt -p "(rename-session '#S')" "rename-session '%%'"

# Pane navigation
bind > swap-pane -D # swap current pane with the next one
bind < swap-pane -U # swap current pane with the previous one

# Window navigation
bind l next-window
bind h previous-window
bind a last-window

# Swap windows
bind H swap-window -t -1
bind L swap-window -t +1

# Prefix + / to search
bind / copy-mode \; send-key ?

# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# Kill pane
bind -n C-q if-shell "$is_vim" "send-keys C-q"  "kill-pane"

# Split windows
bind v split-window -h # Split panes vertically
bind s split-window -v # Split panes horizontally

# Break pane to a new window
bind B break-pane

# Set Copy-Mode settings
bind [ copy-mode
bind -T copy-mode-vi 'v' send -X begin-selection
bind -T copy-mode-vi 'y' send -X copy-selection
bind -T copy-mode-vi 'V' send -X rectangle-toggle
bind ] paste-buffer

# ============== STATUSBAR ===============

set-option -g status "on"

# default statusbar color
set-option -g status-style bg=default,fg=$gruvbox_material_white

# pane border colours
set -g pane-active-border-style bg=default,fg=$gruvbox_material_white
set -g pane-border-style fg=$gruvbox_material_visual_grey

# Statusbar alignment and text defaults
set-option -g status-position top
set-option -g pane-border-status top
set-option -g pane-border-format '─'
set-option -g status-justify "left"
set-option -g status-left-style none
set-option -g status-right-style none

# Statusbar separator
set-window-option -g window-status-separator " "

# Set statusbar
set-option -g status-left "#[fg=$gruvbox_material_blue][#S] #[fg=$gruvbox_material_red]#{?window_zoomed_flag,  ,} "
set-option -g status-right "#[fg=$gruvbox_material_blue]#(~/bin/apple_music)#(~/bin/mpd)#[fg=$gruvbox_material_white] | #{cpu_fg_color} #{cpu_percentage} #[fg=$gruvbox_material_white]|  #(~/bin/battery -p -e -t)| #{clima} |#[fg=$gruvbox_material_yellow]  %a %d/%m %H:%M"

set-window-option -g window-status-current-format "#[fg=colour2]#I:#[fg=colour2, bold]#W "
set-window-option -g window-status-format "#[fg=colour8]#I:#[fg=colour8, bold]#W "

# bell & activity
set-window-option -g window-status-bell-style fg=colour167
set-window-option -g window-status-activity-style fg=colour237

# Ressurrect hook to restore processes
set -g @resurrect-hook-pre-restore-pane-processes 'tmux switch-client -n && tmux kill-session -t=0'

# ============== PLUGINS =============

# (see https://github.com/tmux-plugins)

# Usage:
# Prefix + I - to install plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# weather info
set -g @plugin 'vascomfnunes/tmux-clima'
set -g @clima_location "Buxton, UK"
set -g @clima_latitude "53.258949"
set -g @clima_longitude "-1.913020"

# open url in browser
set -g @plugin 'wfxr/tmux-fzf-url' # prefix + u

set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

# copy to clipboard using hints
set -g @plugin 'fcsonline/tmux-thumbs' # prefix + space
set -g @thumbs-command 'echo -n {} | pbcopy'

# jump to text and enter copy mode using hints
set -g @plugin 'schasse/tmux-jump' # prefix + j

# Restore tmux environment after system restart.
# Keybindinds:
# prefix + Ctrl-s - save
# prefix + Ctrl-r - restore

set -g @plugin 'tmux-plugins/tmux-resurrect'

# Don't capture the pane contents to avoid a mess
set -g @resurrect-capture-pane-contents 'off'

# Ressurrect processes when possible
set -g @resurrect-processes 'true'
set -g @resurrect-processes 'newsboat podboat pyradio neomutt vifm ncmpcpp vim nvim'

# Restore environment when tmux is started
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

set -g @plugin 'tmux-plugins/tmux-cpu'

# Background color when cpu is low
set -g @cpu_low_fg_color "#[fg=$gruvbox_material_green]"

# Background color when cpu is medium
set -g @cpu_medium_fg_color "#[fg=$gruvbox_material_yellow]"

# Background color when cpu is high
set -g @cpu_high_fg_color "#[fg=$gruvbox_material_red]"

# printf format to use to display percentage
set -g @cpu_percentage_format "%4.1f%%"

set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'RyanMillerC/better-vim-tmux-resizer'
set -g @plugin 'tmux-plugins/tmux-sessionist' # prefix + C to create session' prefix + X to kill session

# thumbs (use with prefix + space)
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @thumbs-hint-bg-color red
set -g @thumbs-hint-fg-color black

# Yank
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_selection_mouse 'clipboard'

# fzf
set -g @plugin 'sainnhe/tmux-fzf'
TMUX_FZF_LAUNCH_KEY="f"

# automatic tpm installation
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'

# set -g default-command fish
# set -g default-shell fish
